<html :sample="$data{list://item[1]/@name}">
<head>
	<title>Ub1 Playground</title>
	<ub1-include href="style.htm"/>
</head>
<body>
	<ub1-dataset :name="list"
	         :server="${makeData()}"
	         :makeData="${function() {
	            var names = sysReadDirectory(sysFSPath + '/samples');
	            names = stringSort(names);
	            return names.map(function(n) {return {name:n.split('.')[0]}});
	         }}"/>

	<ub1-dataset :name="source"
	         :src="/playground/samples/${sample}.html?ub1_source_in=true"/>

	<ub1-dataset :name="text"
	         :src="/playground/texts/${sample}.md"/>

	<div class="toolbar">
		<ub1-include href="logo.htm"/>
		<button :ev_click="${window.open('https://github.com/fcapolini/ub1', '_blank')}"
				title="GitHub Project">
			<i class="fa fa-fw fa-github" style="margin-left:-1px;font-size:120%"/>
		</button>
		<button :ev_click="${window.location.href = 'mailto:admin@ub1devel.net'}"
				title="Contact Us">
			<i class="fa fa-fw fa-envelope" style="padding-bottom:3px"/>
		</button>
		<button :ev_click="${messageDialog.open = true}"
				s_display="none"
		        title="Submit a Comment">
			<i class="fa fa-fw fa-comment" style="padding-bottom:3px"/>
		</button>
	</div>

	<div class="main">
		<div class="left-bar">
			<div class="left-top">
				<ol>
					<li :foreach="list:/root/item">
						<span c_link
							c_selected="${sample == dataGet('@name')}"
							:sampleName="${dataGet('@name').split('_')[1]}"
							:ev_click="${sample = dataGet('@name')}">
							${regex('-', 'g').replace(sampleName, ' ')}
						</span>
					</li>
				</ol>
			</div>
			<div class="left-bottom"/>
		</div>

		<div class="center">
			<div class="center-top">
				<form :name="form"
				      class="form"
				      target="view"
				      method="post"
				      action="/playground/samples/dummy.html">

					<input :name="hidden"
					       type="hidden"
					       name="ub1_source_compile"/>

					<div class="editor"
					     :datapath="source:/html/body/pre"
					     :content="$data{text()}"
					     :on_content="${content != '' ? setContent() : null}"
					     :keydownHandler="${(sysKeydown):function() {
					        if (sysKeydown.name == 'CMD-S') {
					            sysKeydown.preventDefault();
						        submit.prepare();
						        form.dom.submit();
					        }
					     }}"
					     :setContent="${function() {
					        // wait till ace editor is ready
					        if (window.editor == null) {
					            Timer.delay(setContent, 200);
					            return;
					        }
					        // set value and reset undo history
				            window.editor.session.setValue(content, -1);
				            window.editor.focus();
					        submit.prepare();
					        form.dom.submit();
					     }}"></div>

					<button class="submit"
					        title="Refresh Preview [${sysCommandKey}-S]"
					        :name="submit"
					        :ev_click="${prepare()}"
					        :prepare="${function() {
					            hidden.dom.value = window.editor.getValue();
					            window.editor.focus();
					        }}">
						<i class="fa fa-flip-horizontal fa-undo"/>
					</button>
				</form>

				<iframe name="view"
				        class="view"
				        :on_sysInit="${tickHandler()}"
				        :tickHandler="${function() {
				            var w = dom.contentWindow;
				            w.addEventListener('keydown', keydownHandler);
				            Timer.delay(tickHandler, 500);
				        }}"
				        :keydownHandler="${function(ev) {
				            if (sysKeydownPatch(ev).name == 'CMD-S') {
				                ev.preventDefault();
				                form.submit.prepare();
						        form.dom.submit();
				            }
				        }}"/>
			</div>

			<div class="bottom-bar">
				<div :content="$data{text:/text/text()}"
				      :innerHtml="${window.converter.makeHtml(content)}"
				      :innerHtmlHandler="${(innerHtml):function() {
				        //dom.style.opacity = '0';
				        Timer.delay(doPatch, 0);
				      }}"
				      :doPatch="${function() {
				        var ee = dom.getElementsByTagName('pre');
				        // https://github.com/ajaxorg/ace/wiki/Configuring-Ace
				        for (i in 0...ee.length) {
				            ee[i].style.height = ee[i].clientHeight + 'px';
				            var editor = window.ace.edit(ee[i]);
				            editor.setOptions({
				                selectionStyle: 'text',
				                fontSize: 11,
				                readOnly: true,
				                showGutter: false,
				                showPrintMargin: false,
				                highlightActiveLine: false,
				                behavioursEnabled: false,
				                theme: 'ace/theme/chrome',
				                mode: 'ace/mode/php',
				            });
				            var s = editor.session.getValue();
				            editor.session.setValue(trim(s));
				            //so matching closing tag isn't highlighted
				            editor.navigateLineEnd();
				            // https://stackoverflow.com/a/32806309
				            var l = editor.renderer['$cursorLayer'].element;
				            l.style.display = 'none';
				        }
				        //dom.style.opacity = null;
				     }}"/>
			</div>
		</div>
	</div>

	<ub1-include href="message.htm"/>

	<!-- https://ace.c9.io/#nav=embedding -->
	<script src="/res/ace-builds/src-min-noconflict/ace.js"></script>
	<script>
		window.addEventListener('load', function(ev) {
			var div = document.querySelector('.editor');
			editor = ace.edit(div);
			editor.setTheme("ace/theme/chrome");
			editor.session.setMode("ace/mode/php");
			editor.setOption('scrollPastEnd', .33);
			div.style.display = 'block';
	    });
	</script>

	<!-- https://github.com/showdownjs/showdown -->
	<script src="/res/showdown/showdown.min.js"></script>
	<script>
		window.converter = new showdown.Converter();
	</script>
</body>
</html>